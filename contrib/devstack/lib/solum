# lib/solum

# Dependencies:
# ``functions`` file
# ``DEST``, ``DATA_DIR``, ``STACK_USER`` must be defined
# ``ADMIN_{TENANT_NAME|PASSWORD}`` must be defined

# ``stack.sh`` calls the entry points in this order:
#
# install_solum
# configure_solum
# start_solum
# stop_solum

# Save trace setting
XTRACE=$(set +o | grep xtrace)
set +o xtrace

# Defaults
# --------

# Set up default repos
SOLUM_REPO=${SOLUM_REPO:-${GIT_BASE}/stackforge/solum.git}
SOLUM_BRANCH=${SOLUM_BRANCH:-master}

# Set up default directories
SOLUM_DIR=$DEST/solum
SOLUM_CONF_DIR=${SOLUM_CONF_DIR:-/etc/solum}
SOLUM_CONF_FILE=solum.conf
ADMIN_TENANT_NAME=${ADMIN_TENANT_NAME:-admin}
ADMIN_NAME=${ADMIN_NAME:-admin}
ADMIN_PASSWORD=${ADMIN_PASSWORD:-nova}
SOLUM_DEBUG=${SOLUM_DEBUG:-True}

SOLUM_SERVICE_HOST=${SOLUM_SERVICE_HOST:-$SERVICE_HOST}
SOLUM_SERVICE_PORT=${SOLUM_SERVICE_PORT:-9777}
SOLUM_SERVICE_PROTOCOL=${SOLUM_SERVICE_PROTOCOL:-$SERVICE_PROTOCOL}

# Support entry points installation of console scripts
if [[ -d $SOLUM_DIR/bin ]]; then
    SOLUM_BIN_DIR=$SOLUM_DIR/bin
else
    SOLUM_BIN_DIR=$(get_python_exec_prefix)
fi

# Functions
# ---------

# create_solum_service_and_endpoint() - Set up required solum service and endpoint
function create_solum_service_and_endpoint() {

    if [[ "$KEYSTONE_CATALOG_BACKEND" = 'sql' ]]; then
        SOLUM_SERVICE=$(keystone service-create \
            --name=solum \
            --type=application_deployment \
            --description="Solum" \
            | grep " id " | get_field 2)
        keystone endpoint-create \
            --region RegionOne \
            --service_id $SOLUM_SERVICE \
            --publicurl "$SOLUM_SERVICE_PROTOCOL://$SOLUM_SERVICE_HOST:$SOLUM_SERVICE_PORT" \
            --adminurl "$SOLUM_SERVICE_PROTOCOL://$SOLUM_SERVICE_HOST:$SOLUM_SERVICE_PORT" \
            --internalurl "$SOLUM_SERVICE_PROTOCOL://$SOLUM_SERVICE_HOST:$SOLUM_SERVICE_PORT"
    fi
}

# configure_solum() - Set config files, create data dirs, etc
function configure_solum() {

    if [[ ! -d $SOLUM_CONF_DIR ]]; then
        sudo mkdir -p $SOLUM_CONF_DIR
    fi
    sudo chown $STACK_USER $SOLUM_CONF_DIR

    # Copy over solum configuration file and configure common parameters.
    cp $SOLUM_DIR/etc/solum/solum.conf.sample $SOLUM_CONF_DIR/$SOLUM_CONF_FILE

    iniset $SOLUM_CONF_DIR/$SOLUM_CONF_FILE DEFAULT debug $SOLUM_DEBUG

    iniset $SOLUM_CONF_DIR/$SOLUM_CONF_FILE DEFAULT use_syslog $SYSLOG

    # Disable keystone auth for now, until we work out
    # keystone support in our functional tests
    iniset $SOLUM_CONF_DIR/$SOLUM_CONF_FILE DEFAULT enable_authentication False
}

# install_solum() - Collect source and prepare
function install_solum() {
    git_clone $SOLUM_REPO $SOLUM_DIR $SOLUM_BRANCH
    setup_develop $SOLUM_DIR
}

# start_solum() - Start running processes, including screen
function start_solum() {
    screen_it solum "cd $SOLUM_DIR && $SOLUM_BIN_DIR/solum-api --config-file $SOLUM_CONF_DIR/$SOLUM_CONF_FILE"
}

# stop_solum() - Stop running processes
function stop_solum() {
    # Kill the solum screen windows
    screen -S $SCREEN_NAME -p solum -X kill
}


# Restore xtrace
$XTRACE

# Local variables:
# mode: shell-script
# End:
